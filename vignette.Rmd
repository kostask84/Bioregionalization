---
title: "Tutorial for Bioregionalization R package"
output: 
  - pdf_document
  - html_document
editor_options: 
  chunk_output_type: console
---

<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE,
                      fig.width = 12, fig.height = 12)
# Packages --------------------------------------------------------------------
suppressPackageStartupMessages({
  suppressWarnings({
    library(Bioregionalization)
    library(dplyr)
    library(sf)
    library(ggplot2)
    library(cowplot)
  })
})

options(tinytex.verbose = TRUE)

```

`virtual_sp` is a dataset simulated that comes with the package.
This dataset relies on the response curve of virtual species to a virtual
raster.
The virtual raster contains 10000 cells and was simulated using `gstat`
R package.
[See here for details.](http://santiago.begueria.es/2010/10/generating-spatially-correlated-random-fields-with-r/)

Based on this layer, the `virtualspecies` R package (Leroy et al. 2015)
was used to simulate the response curve of 100 virtual species.
A Gaussian curve was used.
The mean and standard deviation of the response function was varying among
species, such as some of them are more or less generalists/specialists.

For every species in every cell, we could derive a suitability index.
Species with suitability index inferior to 0.15 were arbitrarily set absent.

```{r dataset}
# Import virtual dataset
data("virtual_sp")
```

The first step is to convert the data.frame into a contingency table.

```{r contingency_matrix}
sp_mat <- contingency(sp_df, "sp", "site", "pa", binary = TRUE)
```

We then need to project the network.

```{r projection}
sp_proj <- project_network(sp_mat, similarity = "simpson")
sp_proj <- sp_proj[, c("id1", "id2", "simpson")]

# write.table(sp_proj[, c("id1", "id2", "simpson")], "OSLOM2/vignette.txt",
#             row.names = FALSE)

```

Running OSLOM (under Linux distribution).

Here:
./oslom_undir -r 10 -seed 1000 -t 0.5 -cp 0.5 -f vignette.txt -w

Converting the OSLOM .tp file into a list.

```{r conversion_OSLOM}
res <- readLines("OSLOM2/vignette.txt_oslo_files/tp")
oslom_vignette <- oslom_output(res, sp_mat)
length(unique(oslom_vignette$bioregion))
```

Function to compute zscores.

Example with CA analysis and k-means clustering.

```{r CA_cluster, eval = FALSE}
CA_res <- CA_cluster(sp_mat)
```

Projection on a map.

```{r map}
plot_grid(
  # Plot of environmental values
  sp_df %>%
    distinct(site, .keep_all = TRUE) %>%
    ggplot(aes(x, y)) +
    geom_tile(aes(fill = sim1, color = sim1),
              alpha = 0.8, width = 1, height = 1) +
    scale_color_distiller("Value", palette = "OrRd") +
    scale_fill_distiller("Value", palette = "OrRd") +
    coord_equal() +
    labs(title = "Environmental variable") +
    theme(panel.background = element_rect(fill = "transparent",colour = NA)),
  
  # Plot of bioregions
  sp_df %>%
    left_join(oslom_vignette, by = "site") %>%
    distinct(site, .keep_all = TRUE) %>%
    ggplot(aes(x, y)) +
    geom_tile(aes(fill = as.factor(bioregion), color = as.factor(bioregion)),
              alpha = 0.8, width = 1, height = 1) +
    scale_color_viridis_d("Bioregions", option = "E") +
    scale_fill_viridis_d("Bioregions", option = "E") +
    coord_equal() +
    labs(title = "OSLOM bioregions") +
    theme(panel.background = element_rect(fill = "transparent",colour = NA)),
  
  nrow = 1)

# With sf
# res_map <- sp_df %>%
#   left_join(oslom_vignette, by = "site") %>%
#   st_as_sf(coords = c("x", "y")) %>%
#   group_by(bioregion) %>% 
#   summarise()
# 
# ggplot(res_map) +
#   geom_sf(aes(fill = as.factor(bioregion), color = as.factor(bioregion))) +
#   scale_fill_viridis_d("Bioregions") +
#   scale_color_viridis_d("Bioregions") +
#   labs(x = "Longitude", y = "Latitude")

```

